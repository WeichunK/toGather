<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="styles/header_footer.css">


    <link rel="stylesheet" type="text/css" href="styles/profile.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        #profileList {
            margin: 0 auto;
        }
    </style>

    <link href="./assets/favicon.ico" rel="shortcut icon" type="image/ico">

</head>

<body>






    <!-- ---------------------- header --------------------------- -->
    <!-- #e3f2fd; -->
    <div id="header" style="position: absolute;">
        <nav class="navbar navbar-light fixed-top navbar-expand-lg"
            style="background-color: rgba(255, 255, 255); padding:0%; padding-top: 5px">
            <div class="container-md" style="width: 90%; max-width: 90%; height:60px">

                <a class="navbar-brand logo name" href="./index.html">
                    <img src="./assets/new_logo2.png" alt="" height="35">
                </a>
                <div id="main-header">
                    <div class="collapse navbar-collapse" id="navbarNavDropdown">
                        <ul class="navbar-nav" style="align-items: center;">


                            <li class="nav-item" style="margin: 0 0 0 0;" data-bs-toggle="offcanvas"
                                data-bs-target="#offcanvasWithBackdrop" aria-controls="offcanvasWithBackdrop">
                                <a class="nav-link" href="#" style="display: flex;">
                                    <!-- <img src="./assets/6590582_box_email_mail_mailbox_icon.png"
                                            style="width: 36px;"> -->

                                    <span class="material-icons">
                                        all_inbox
                                    </span>
                                </a>
                            </li>
                            <!-- <li class="nav-item" style="display: flex;">
                                    <a class="nav-link" id="caht" href="#"><svg xmlns=" http://www.w3.org/2000/svg"
                                            width="47" height="47" fill="currentColor" class="bi bi-chat-left-text"
                                            viewBox="0 0 16 16">
                                            <path
                                                d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                            <path
                                                d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z" />
                                        </svg></a>
                                </li> -->
                            <li class="nav-item dropdown" style="margin: 0 0 0 0;">
                                <a class="nav-link" href="#" id="navbarDropdownMenuLink" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false" style="display: flex;">

                                    <!-- <svg xmlns="http://www.w3.org/2000/svg" width="47" height="47"
                                            fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                                            <path fill-rule="evenodd"
                                                d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
                                        </svg> -->
                                    <!-- <img src="./assets/3018530_buyer_customer_figure_person_portrait_icon.png"
                                            style="width: 36px;"> -->
                                    <span class="material-icons">
                                        account_circle
                                    </span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="navbarDropdownMenuLink">
                                    <li><a class="dropdown-item dropdown-sign" href="/sign.html"
                                            style="display: block;">登入</a>
                                    </li>
                                    <li><a class="dropdown-item dropdown-signed" href="/profile.html"
                                            style="display: none;">會員資料</a></li>
                                    <li>
                                        <hr class="dropdown-divider dropdown-signed" style="display: none;">
                                    </li>
                                    <li id=signout><a class="dropdown-item dropdown-signed" href="#"
                                            style="display: none;">登出</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <!-- -------------------------------------------------- -->


    <div class='wrap'>

        <div id="left">


            <div id=profileList>









                <div class="rating-box" style="position:relative; width: 100%;">
                    <h5 class="rating-boxH1" style="text-align: center;">我的評分</h5>
                    <div class="ratingResult" style="text-align: center;">
                        <span class="fa fa-star-o" style="font-size:36px; color: gold;"></span>
                        <span class="fa fa-star-o" style="font-size:36px; color: gold;"></span>
                        <span class="fa fa-star-o" style="font-size:36px; color: gold;"></span>
                        <span class="fa fa-star-o" style="font-size:36px; color: gold;"></span>
                        <span class="fa fa-star-o" style="font-size:36px; color: gold;"></span>
                    </div>
                    <p id="rating-description" class="text-muted" style="text-align: center;">目前尚未有人給評分</p>
                    <h4 id="rating-value">
                        </h1>
                </div>








            </div>




        </div>


        <div id="right">





            <div class="accordion" id="accordionPanelsStayOpenExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
                            aria-controls="panelsStayOpen-collapseOne">
                            即將到來的活動
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show"
                        aria-labelledby="panelsStayOpen-headingOne">
                        <div id="comingEvent" class="card" style="width: 100%;cursor:pointer;">






                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
                            aria-controls="panelsStayOpen-collapseTwo">
                            已完成的活動
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse"
                        aria-labelledby="panelsStayOpen-headingTwo">
                        <div id="pastEvent" class="card" style="width: 100%; cursor:pointer;">






                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
                            aria-controls="panelsStayOpen-collapseThree">
                            你發起的活動
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse"
                        aria-labelledby="panelsStayOpen-headingThree">
                        <div id="ownEvent" class="card" style="width: 100%; cursor:pointer;">






                        </div>





                    </div>
                </div>
            </div>








        </div>




    </div>








    <!-- Modal block-->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="staticBackdropLabel">請上傳您的個人照</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <form method="post" enctype="multipart/form-data">


                        <div class="mb-3">
                            <label for="main_image" class="form-label">圖片</label>
                            <input class="form-control" type="file" name="main_image" id="main_image">
                            <p class="modal-content text-muted" style="border: none;"><small>圖片請勿超過2mb</small></p>
                        </div>





                        <button type="submit" class="btn btn-primary" id="gathering_submit"
                            onclick="return onClick(this.form)">確定上傳</button>
                    </form>






                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <!-- <button type="button" class="btn btn-primary">Understood</button> -->
                </div>
            </div>
        </div>
    </div>

    <!-- -------------------------------------------- -->







    <!-- ------------------------offcanvas block------------------------------------ -->







    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasWithBackdrop"
        aria-labelledby="offcanvasWithBackdropLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasWithBackdropLabel">系統訊息</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="card" style="width: 100%;">
                <ul class="list-group list-group-flush" id=sys-message-list>

                </ul>
            </div>
        </div>
    </div>










    <!-- ------------------------------------------------------------------------------- -->












    <script>





        // function ajax(src, callback) {

        //     if (localStorage.getItem("token")) {
        //         const accessToken = localStorage.getItem("token");
        //         let response
        //         const xhr = new XMLHttpRequest()
        //         xhr.onreadystatechange = function () {
        //             if (xhr.readyState === 4 && xhr.status === 200) {
        //                 response = JSON.parse(xhr.responseText)
        //                 // response = xhr.responseText;
        //                 callback(response)
        //             }
        //         }
        //         function sendAJAX(accessToken) {
        //             xhr.open('GET', src)
        //             if (accessToken) {
        //                 // console.log('accessToken: ', accessToken)
        //                 xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
        //             }

        //             xhr.send()
        //         }
        //         sendAJAX(accessToken)

        //     } else {
        //         Swal.fire({
        //             title: 'Error!',
        //             text: '請先登入',
        //             icon: 'error',
        //             confirmButtonText: 'OK'
        //         })
        //     }

        // }







        // ajax('/api/1.0/user/getmemberprofile', function (response) {
        //     // console.log(response);
        //     console.log('response', response)

        //     let profileList = document.getElementById('profileList')


        //     let name = document.createElement('li')
        //     name.textContent = response.data.name;
        //     // participant.textContent = response.data[i].user_name;
        //     // participant.setAttribute('onclick', `location.href='http://localhost:3000/profile.html?id=${response.data[i].id}';`)
        //     // participant.style = `cursor:pointer;`
        //     profileList.appendChild(name);

        //     let email = document.createElement('li')
        //     console.log('response.data.email', response.data.email)
        //     email.textContent = response.data.email;
        //     profileList.appendChild(email);

        //     let gender = document.createElement('li')
        //     email.textContent = response.data.gender;
        //     profileList.appendChild(gender);



        // })











        function fetchData(src, accessToken) {
            // console.log('access', accessToken)

            function processStatus(response) {
                // 狀態 "0" 是處理本地檔案 (例如Cordova/Phonegap等等)
                if (response.status === 200 || response.status === 0) {
                    return Promise.resolve(response)
                } else {
                    return Promise.reject(new Error(response.statusText))
                }
            }

            if (accessToken) {
                const headers = {
                    // 'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }

                return fetch(src, { headers: headers })
                    .then(processStatus)
                    .then((response) => { return response.json(); })
                    .catch((error) => {
                        console.log(error);
                    })

            } else {
                Swal.fire({
                    title: 'Error!',
                    text: '請先登入',
                    icon: 'error',
                    confirmButtonText: 'OK'
                })
            }

        }












        async function initProfile() {


            // var socket = io();

            // var hostInfo = {};
            // var user = {}
            // var gathering = {}

            const accessToken = localStorage.getItem("token")


            let profile = await fetchData('/api/1.0/user/getmemberprofile', accessToken)
            let url = location.href
            let profileId
            let profileData
            if (url.split('?')[1]) {
                profileId = url.split('?')[1].split('=')[1]
                profileData = await fetchData(`/api/1.0/user/getprofile?id=${profileId}`, accessToken)

            } else {
                profileData = profile
            }





            // console.log('response getmemberprofile', profile)


            user = profile.data



            console.log('profileData', profileData)

            let profileList = document.getElementById('profileList')
            profileList.class = "card"
            profileList.style = "width:60%;"
            console.log('profileData.data.picture', profileData.data.picture)

            let profilePicContainer = document.createElement('div')
            profilePicContainer.style = "display:flex; justify-content:center;"

            let profilePic = document.createElement('img')
            profilePic.src = profileData.data.picture || '';
            profilePic.className = "card-img-top"

            // profilePic.style = "height:30vh;object-fit: contain;background-image:url('https://mir-s3-cdn-cf.behance.net/project_modules/disp/a5f35a112938979.601ee0c09cecd.gif')"

            profilePic.style = "width:25vh; object-fit: contain; border-radius: 50%; border: 1px solid rgba(255,56,92,1.00);"
            profilePicContainer.appendChild(profilePic)


            let cardBody = document.createElement('div')
            cardBody.className = "card-body";

            let cardName = document.createElement('h5')
            cardName.className = "card-title";
            cardName.appendChild(document.createTextNode(profileData.data.name))

            cardBody.appendChild(cardName)

            // let cardTitle = document.createElement('h6')
            // cardTitle.className = "card-title";
            // cardTitle.appendChild(document.createTextNode('Introduction'))


            // let cardIntroduction = document.createElement('p')
            // cardIntroduction.className = "card-text";
            // cardIntroduction.style = "white-space: pre-line;"
            // cardIntroduction.appendChild(document.createTextNode(`${profileData.data.introduction || '未提供'}`))
            // // console.log(getgatheringDetails.data[0].description)

            // cardBody.appendChild(cardTitle)
            // cardBody.appendChild(cardIntroduction)

            let listGroupItem

            let listGroup = document.createElement('ul');
            listGroup.className = "list-group list-group-flush";

            let email = document.createElement('li');
            email.className = "list-group-item";
            email.appendChild(document.createTextNode(`email ${profileData.data.email}`))


            // let age = document.createElement('li');
            // age.className = "list-group-item";
            // age.appendChild(document.createTextNode(`年齡 ${profileData.data.age || '未提供'}`))


            // let job = document.createElement('li');
            // job.className = "list-group-item";
            // job.appendChild(document.createTextNode(`職業 ${profileData.data.job || '未提供'}`))



            let popularity = document.createElement('li');
            popularity.className = "list-group-item";
            popularity.appendChild(document.createTextNode(`積分 ${profileData.data.popularity}`))












            let changePicButton = document.createElement('a');
            changePicButton.className = "btn btn-primary";
            changePicButton.id = "changePic";
            changePicButton.style = "display: none;"
            changePicButton.setAttribute("data-bs-toggle", "modal")
            changePicButton.setAttribute("data-bs-target", "#staticBackdrop")
            changePicButton.setAttribute("autocomplete", "off")
            changePicButton.appendChild(document.createTextNode("更換照片"))

            if (user.id == profileData.data.id) {
                changePicButton.style = "display: block;"
            }



            listGroup.appendChild(email)
            // listGroup.appendChild(age)
            // listGroup.appendChild(job)
            listGroup.appendChild(popularity)

            listGroup.appendChild(changePicButton)

            listGroup.appendChild(document.createElement('br'))
            // listGroup.appendChild(returnHome)



            profileList.insertBefore(listGroup, profileList.firstChild)
            // gatheringDetail.appendChild(listGroup)

            profileList.insertBefore(cardBody, profileList.firstChild)



            profileList.insertBefore(profilePicContainer, profileList.firstChild)




            let returnHome = document.createElement('a');
            returnHome.className = "btn btn-primary btn-sm box4";


            returnHome.setAttribute("onclick", 'location.href="/index.html"')
            returnHome.setAttribute("data-bs-toggle", "button")
            returnHome.setAttribute("autocomplete", "off")
            returnHome.appendChild(document.createTextNode("回首頁"))

            profileList.appendChild(document.createElement('br'))

            profileList.appendChild(returnHome)


            let ratingData = await fetchData('/api/1.0/user/getuserrating', accessToken)

            console.log('ratingData', ratingData)



            // let profileListUl = document.createElement('ul')

            // let pic = document.createElement('li')
            // let img = document.createElement('img')



            // let name = document.createElement('li')
            // name.textContent = profileData.data.name;
            // // participant.textContent = response.data[i].user_name;
            // // participant.setAttribute('onclick', `location.href='http://localhost:3000/profile.html?id=${response.data[i].id}';`)
            // // participant.style = `cursor:pointer;`
            // profileListUl.appendChild(name);

            // let email = document.createElement('li')
            // // console.log('profileList.data.email', profileData.data.email)
            // email.textContent = profileData.data.email;
            // profileListUl.appendChild(email);

            // let gender = document.createElement('li')
            // // console.log('gender', profileData.data.gender)
            // gender.textContent = profileData.data.gender || '未提供';
            // profileListUl.appendChild(gender);

            // profileList.appendChild(profileListUl)





            // console.log('memberprofile', profileData)


            // let profileList = document.getElementById('profileList')

            // let listGroup = document.createElement('ul');
            // listGroup.className = "list-group list-group-flush";




            // let listGroupItem = document.createElement('li');
            // listGroupItem.className = "list-group-item";
            // listGroupItem.appendChild(document.createTextNode(`地點 ${getgatheringDetails.data[0].place}`))


            // let time = document.createElement('li');
            // time.className = "list-group-item";
            // time.appendChild(document.createTextNode(`時間 ${getgatheringDetails.data[0].start_at}`))



            // let minParticipant = document.createElement('li');
            // minParticipant.className = "list-group-item";
            // minParticipant.appendChild(document.createTextNode(`幾人成團 ${getgatheringDetails.data[0].min_participant}`))



            let ratingScore = parseFloat(ratingData.data.rating).toFixed(2)
            // let ratingScore = parseFloat('3.512334').toFixed(2)



            if (ratingScore == 0) {
                document.getElementById('rating-description').textContent = '目前尚未有人給評分'
            } else {
                document.getElementById('rating-description').textContent = `${ratingScore} / 5`
            }



            const stars = document.querySelector(".ratingResult").children;
            // let ratingValue
            let index

            for (let j = 0; j < stars.length; j++) {
                stars[j].classList.remove("fa-star")//reset 所有星星
                stars[j].classList.add("fa-star-o")
            }
            for (let j = 0; j < ratingScore - 0.5; j++) {
                stars[j].classList.remove("fa-star-o")
                stars[j].classList.add("fa-star")
            }





            // ------------------------------ Event List -------------------------------------




            let gatheringList = await fetchData(`/api/1.0/getgatherings/mygatheringlist?id=${profileData.data.id}`, accessToken)


            let comingEvent = document.getElementById("comingEvent")
            let pastEvent = document.getElementById("pastEvent")

            let currentTime = new Date();
            console.log('currentTime', currentTime)

            for (let i in gatheringList.data) {




                let eventBlock = document.createElement('div')
                eventBlock.setAttribute('class', 'card mb-3')
                // eventBlock.setAttribute('onclick', `return clickGathering(${response.data[i].id});`)
                eventBlock.setAttribute('onclick', `location.href='/gathering.html?id=${gatheringList.data[i].id}';`)
                eventBlock.setAttribute('id', gatheringList.data[i].id)
                eventBlock.style = "max-width: 100%;"


                let eventBlockRow = document.createElement('div')
                eventBlockRow.setAttribute('class', 'row g-0')

                let eventBlockRowPic = document.createElement('div')
                eventBlockRowPic.setAttribute('class', 'col-md-4')
                // eventBlockRowPic.style = "min-height:80%;"

                let eventPic = document.createElement('img')
                eventPic.setAttribute('class', 'figure-img img-fluid rounded gathering-pic')
                eventPic.setAttribute('src', gatheringList.data[i].picture)
                eventPic.style = "margin: 3px; object-fit: cover; width:90%; height:90%;"

                eventBlockRowPic.appendChild(eventPic)

                let eventBlockRowContent = document.createElement('div')
                eventBlockRowContent.setAttribute('class', 'col-md-8')

                let eventBlockRowCardBody = document.createElement('div')
                eventBlockRowCardBody.setAttribute('class', 'card-body')


                let eventBlockRowCardTitle = document.createElement('h5')
                eventBlockRowCardTitle.setAttribute('class', 'card-title')
                eventBlockRowCardTitle.appendChild(document.createTextNode(` ${gatheringList.data[i].title}`))

                let eventBlockRowCardText = document.createElement('p')
                eventBlockRowCardText.setAttribute('class', 'card-text')
                eventBlockRowCardText.style = "font-size: 0.8rem;"
                eventBlockRowCardText.appendChild(document.createTextNode(` ${gatheringList.data[i].description.substring(0, 30)}...`))


                let eventBlockRowCardTime = document.createElement('p')
                eventBlockRowCardTime.setAttribute('class', 'card-text')

                let eventBlockRowCardTimeSmall = document.createElement('small')
                eventBlockRowCardTimeSmall.setAttribute('class', 'text-muted')

                eventBlockRowCardTimeSmall.setAttribute('id', `start-time_${gatheringList.data[i].id}`)

                // let startTime = new Date(Date.parse(new Date(gatheringList.data[i].start_at).toUTCString()))
                console.log('gatheringList.data[i].start_at', gatheringList.data[i].start_at)
                let startTime = new Date(gatheringList.data[i].start_at)
                console.log('startTime', startTime)

                // console.log('UTC', startTime.getUTCMonth(), startTime.getUTCDate(), startTime.getUTCHours(), startTime.getUTCMinutes())
                // console.log(startTime.getMonth(), startTime.getDate(), startTime.getHours(), startTime.getMinutes())


                eventBlockRowCardTimeSmall.appendChild(document.createTextNode(`時間 ${startTime.getUTCFullYear()}-${((parseInt(startTime.getUTCMonth()) + 1) < 10 ? '0' : '') + (parseInt(startTime.getUTCMonth()) + 1)}-${(startTime.getUTCDate() < 10 ? '0' : '') + startTime.getUTCDate()}  ${(startTime.getUTCHours() < 10 ? '0' : '') + startTime.getUTCHours()}:${(startTime.getUTCMinutes() < 10 ? '0' : '') + startTime.getUTCMinutes()}`))
                eventBlockRowCardTime.appendChild(eventBlockRowCardTimeSmall)







                eventBlockRowCardBody.appendChild(eventBlockRowCardTitle)
                eventBlockRowCardBody.appendChild(eventBlockRowCardText)
                eventBlockRowCardBody.appendChild(eventBlockRowCardTime)

                eventBlockRowContent.appendChild(eventBlockRowCardBody)


                eventBlockRow.appendChild(eventBlockRowPic)
                eventBlockRow.appendChild(eventBlockRowContent)


                eventBlock.appendChild(eventBlockRow)


                if (startTime > currentTime) {
                    comingEvent.appendChild(eventBlock)

                    let startTimeDiv = document.getElementById(`start-time_${gatheringList.data[i].id}`)

                    let waiting

                    if (String((startTime - currentTime) / (1000 * 60 * 60 * 24)).split('.')[1] > 0) {

                        waiting = parseInt(String((startTime - currentTime) / (1000 * 60 * 60 * 24)).split('.')[0]) + 1
                    } else {
                        waiting = parseInt(String((startTime - currentTime) / (1000 * 60 * 60 * 24)).split('.')[0])
                    }

                    startTimeDiv.innerText += `，再等 ${waiting} 天`







                } else {
                    pastEvent.appendChild(eventBlock)
                }


                // gatheringList.appendChild(document.createElement('br'))





            }





            // status , num participant, click, time





            let hostList = await fetchData(`/api/1.0/getgatherings/myhostlist?id=${profileData.data.id}`, accessToken)


            let hostEvent = document.getElementById("ownEvent")

            if (user.id != profileData.data.id) {
                hostEvent.style = "display:none;"
            }




            let currentTimeforHost = new Date();
            console.log('currentTime', currentTimeforHost)

            for (let i in hostList.data) {




                let eventBlockforHost = document.createElement('div')
                eventBlockforHost.setAttribute('class', 'card mb-3')
                // eventBlock.setAttribute('onclick', `return clickGathering(${response.data[i].id});`)
                eventBlockforHost.setAttribute('onclick', `location.href='/gathering.html?id=${hostList.data[i].id}';`)
                eventBlockforHost.setAttribute('id', hostList.data[i].id)
                eventBlockforHost.style = "max-width: 100%;"


                let eventBlockRowforHost = document.createElement('div')
                eventBlockRowforHost.setAttribute('class', 'row g-0')

                let eventBlockRowPicforHost = document.createElement('div')
                eventBlockRowPicforHost.setAttribute('class', 'col-md-4')
                // eventBlockRowPic.style = "min-height:80%;"

                let eventPicforHost = document.createElement('img')
                eventPicforHost.setAttribute('class', 'figure-img img-fluid rounded gathering-pic')
                eventPicforHost.setAttribute('src', hostList.data[i].picture)
                eventPicforHost.style = "margin: 3px; object-fit: cover; width:90%; height:90%;"

                eventBlockRowPicforHost.appendChild(eventPicforHost)

                let eventBlockRowContentforHost = document.createElement('div')
                eventBlockRowContentforHost.setAttribute('class', 'col-md-8')

                let eventBlockRowCardBodyforHost = document.createElement('div')
                eventBlockRowCardBodyforHost.setAttribute('class', 'card-body')


                let eventBlockRowCardTitleforHost = document.createElement('h5')
                eventBlockRowCardTitleforHost.setAttribute('class', 'card-title')
                eventBlockRowCardTitleforHost.appendChild(document.createTextNode(` ${hostList.data[i].title}`))

                // let eventBlockRowCardTextforHost = document.createElement('p')
                // eventBlockRowCardTextforHost.setAttribute('class', 'card-text')
                // eventBlockRowCardTextforHost.appendChild(document.createTextNode(` ${hostList.data[i].description.substring(0, 30)}...`))


                let eventBlockRowCardTimeforHost = document.createElement('p')
                eventBlockRowCardTimeforHost.setAttribute('class', 'card-text')

                let eventBlockRowCardTimeSmallforHost = document.createElement('small')
                eventBlockRowCardTimeSmallforHost.setAttribute('class', 'text-muted')


                console.log('hostList.data[i].start_at', hostList.data[i].start_at)
                let startTimeforHost = new Date(hostList.data[i].start_at)
                console.log('startTime', startTimeforHost)

                eventBlockRowCardTimeSmallforHost.appendChild(document.createTextNode(`時間 ${startTimeforHost.getUTCFullYear()}-${((parseInt(startTimeforHost.getUTCMonth()) + 1) < 10 ? '0' : '') + (parseInt(startTimeforHost.getUTCMonth()) + 1)}-${(startTimeforHost.getUTCDate() < 10 ? '0' : '') + startTimeforHost.getUTCDate()}  ${(startTimeforHost.getUTCHours() < 10 ? '0' : '') + startTimeforHost.getUTCHours()}:${(startTimeforHost.getUTCMinutes() < 10 ? '0' : '') + startTimeforHost.getUTCMinutes()}`))
                eventBlockRowCardTimeforHost.appendChild(eventBlockRowCardTimeSmallforHost)





                let eventBlockRowCardParticipantforHost = document.createElement('p')
                eventBlockRowCardParticipantforHost.setAttribute('class', 'card-text')

                let eventBlockRowCardParticipantSmallforHost = document.createElement('small')
                eventBlockRowCardParticipantSmallforHost.setAttribute('class', 'text-muted')


                eventBlockRowCardParticipantSmallforHost.appendChild(document.createTextNode(`目前人數 ${hostList.data[i].participant_count}，點閱次數 ${hostList.data[i].click_count}`))
                eventBlockRowCardParticipantforHost.appendChild(eventBlockRowCardParticipantSmallforHost)



                // let eventBlockRowCardClickforHost = document.createElement('p')
                // eventBlockRowCardClickforHost.setAttribute('class', 'card-text')

                // let eventBlockRowCardClickSmallforHost = document.createElement('small')
                // eventBlockRowCardClickSmallforHost.setAttribute('class', 'text-muted')


                // eventBlockRowCardClickSmallforHost.appendChild(document.createTextNode(`點閱次數 ${hostList.data[i].click_count}`))
                // eventBlockRowCardClickforHost.appendChild(eventBlockRowCardClickSmallforHost)



                let eventBlockRowCardStatusforHost = document.createElement('p')
                eventBlockRowCardStatusforHost.setAttribute('class', 'card-text')

                let eventBlockRowCardStatusSmallforHost = document.createElement('small')
                eventBlockRowCardStatusSmallforHost.setAttribute('class', 'text-muted')



                let status_object = { '1': '已開團', '2': '招募中', '3': '已額滿', '4': '已結束', }


                eventBlockRowCardStatusSmallforHost.appendChild(document.createTextNode(`狀態 ${status_object[hostList.data[i].status]}`))
                eventBlockRowCardStatusforHost.appendChild(eventBlockRowCardStatusSmallforHost)









                eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardTitleforHost)
                // eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardTextforHost)
                eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardTimeforHost)
                eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardParticipantforHost)
                // eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardClickforHost)
                eventBlockRowCardBodyforHost.appendChild(eventBlockRowCardStatusforHost)



                eventBlockRowContentforHost.appendChild(eventBlockRowCardBodyforHost)


                eventBlockRowforHost.appendChild(eventBlockRowPicforHost)
                eventBlockRowforHost.appendChild(eventBlockRowContentforHost)


                eventBlockforHost.appendChild(eventBlockRowforHost)



                hostEvent.appendChild(eventBlockforHost)





                // gatheringList.appendChild(document.createElement('br'))





            }
















            // ---------------------------------------------------------------------------------








            //    --------------------------------------system messages block---------------------------- -->



            const renderSystemMessage = async function (accessToken) {



                let systemMessageRecord = await fetchData(`/api/1.0/chat/getsystemrecord`, accessToken)



                // console.log('systemMessageRecord.data[0].content', systemMessageRecord.data[0].content)


                let sysMessageList = document.getElementById('sys-message-list')


                for (let i in systemMessageRecord.data) {
                    // console.log('current user.id', user.id)
                    // console.log('chatRecord[i].user_id', chatRecord[i].user_id)
                    let sysMessageItem = document.createElement('li');

                    // console.log('comapre', 'chatRecord[i].user_id: ', chatRecord[i].user_id, 'user.id:', user.id)
                    sysMessageItem.className = "list-group-item"
                    sysMessageItem.innerText = systemMessageRecord.data[i].content
                    let sysMessageItemSmall = document.createElement('small');
                    sysMessageItemSmall.className = "text-muted";
                    let startTime = new Date(systemMessageRecord.data[i].created_at);
                    sysMessageItemSmall.innerText = `${startTime.getUTCFullYear()}-${((parseInt(startTime.getUTCMonth()) + 1) < 10 ? '0' : '') + (parseInt(startTime.getUTCMonth()) + 1)}-${(startTime.getUTCDate() < 10 ? '0' : '') + startTime.getUTCDate()}  ${(startTime.getUTCHours() < 10 ? '0' : '') + startTime.getUTCHours()}:${(startTime.getUTCMinutes() < 10 ? '0' : '') + startTime.getUTCMinutes()}`









                    sysMessageItem.appendChild(sysMessageItemSmall)


                    sysMessageList.appendChild(sysMessageItem);

                }


                sysMessageList.scrollBy(0, sysMessageList.scrollHeight)




            }







            renderSystemMessage(accessToken)


            // ---------------------------------------------------------------------------------------------- 







        }









        function onClick(form) {
            console.log('type of form', typeof (form))
            console.log('form', form)

            let dataToSent = new FormData(form)
            console.log('dataToSent', dataToSent)

            alert('check')

            if (localStorage.getItem('token')) {
                var jwt = localStorage.getItem('token')
                console.log('JWT', jwt)
                // console.log("files[0].size", document.getElementById("main_image").files[0].size)
                // console.log("files[0]", document.getElementById("main_image").files[0])


                if (!document.getElementById("main_image").files[0]) {
                    Swal.fire({
                        title: 'Error!',
                        text: '圖片不可為空',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(function () {
                        return false;
                    })
                } else if (document.getElementById("main_image").files[0].size > 2 * 1024 * 1024) {
                    Swal.fire({
                        title: 'Error!',
                        text: '圖片尺寸過大',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(function () {
                        return false;
                    })
                } else {
                    Swal.fire({
                        title: 'Success!',
                        text: '資料格式正確，即將為您建檔！',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(function () {
                        window.location.reload();
                    })
                }

            } else {
                alert('請先登入')
                window.location.href = '/admin/signIn.html'
            }
            console.log("dataToSent", dataToSent)
            const accessToken = localStorage.getItem("token");
            // fetch("/api/1.0/getgatherings/hostGathering", {

            //     body: dataToSent,
            //     headers: new Headers({
            //         "Content-Type": "multipart/form-data",
            //         "Authorization": `Bearer ${accessToken}`
            //     }),
            //     method: "POST"
            // }).then((e => e.json())).then((e => {
            //     console.log(e)
            //     alert('error')
            // }
            // )).then(window.alert("註冊成功！")).catch((e => {
            //     console.log(e)
            // }
            // ))


            let xhr = new XMLHttpRequest();
            let url = '/api/1.0//user/updatephoto';
            xhr.open('POST', url);
            xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
            // xhr.setRequestHeader('Content-Type', 'multipart/form-data');

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // console.log('apiResponse.data', xhr.responseText)
                    // if (xhr.responseText == 'admin') {
                    //     alert('已成功輸入一筆資料')
                    //     window.location.href = '/admin/product.html'
                    // } else {
                    //     alert('無權限操作此頁')
                    // }
                    window.location.reload();
                }
            };
            xhr.send(dataToSent);



            // .finally(location.reload())



            return false
        }









        // let getgatheringDetails = await fetchData(`/ api / 1.0 / getgatherings / details ? id = ${gatheringId}`, accessToken)

        // // console.log('getgatheringDetails.data[0].lat', getgatheringDetails.data[0].lat)
        // gathering.title = getgatheringDetails.data[0].title


        // console.log('getgatheringDetails', getgatheringDetails)


        // console.log('getgatheringDetails.user', getgatheringDetails.user)

        // // console.log('getgatheringDetails.data[0]', getgatheringDetails.data[0])

        // // initMap(response.data[0].lat, response.data[0].lng)


        // hostInfo.hostName = getgatheringDetails.data[0].name
        // hostInfo.hostId = getgatheringDetails.data[0].host_id
        // hostInfo.rating = getgatheringDetails.data[0].avg_rating
        // console.log('hostInfo', hostInfo)
        // // console.log('response.data.host_id', response.data[0].host_id)



        // // let mapDiv = document.getElementById("left-map")
        // // mapDiv.style = 'height: 100%;width: 98%;'

        // const gatheringDetail = document.getElementById('gatheringDetail')

        // gatheringDetail.class = "card"
        // gatheringDetail.style = "width:60%;"


        // let eventPic = document.createElement('img')
        // eventPic.src = getgatheringDetails.data[0].picture

        // eventPic.className = "card-img-top"



        // eventPic.style = "height:30vh;object-fit: contain;background-image:url('https://mir-s3-cdn-cf.behance.net/project_modules/disp/a5f35a112938979.601ee0c09cecd.gif')"


        // // gatheringDetail.appendChild(eventPic)


        // let eventMap = document.createElement('div')
        // eventMap.id = "left-map";



        // // gatheringDetail.appendChild(eventMap)


        // let cardBody = document.createElement('div')
        // cardBody.className = "card-body";

        // let cardTitle = document.createElement('h5')
        // cardTitle.className = "card-title";
        // cardTitle.appendChild(document.createTextNode(` ${getgatheringDetails.data[0].title}`))



        // let cardDescriptiion = document.createElement('p')
        // cardDescriptiion.className = "card-text";
        // cardDescriptiion.style = "white-space: pre-line;"
        // cardDescriptiion.appendChild(document.createTextNode(` ${getgatheringDetails.data[0].description}`))
        // // console.log(getgatheringDetails.data[0].description)

        // cardBody.appendChild(cardTitle)
        // cardBody.appendChild(cardDescriptiion)




        // // gatheringDetail.appendChild(cardBody)






        // let listGroup = document.createElement('ul');
        // listGroup.className = "list-group list-group-flush";




        // let listGroupItem = document.createElement('li');
        // listGroupItem.className = "list-group-item";
        // listGroupItem.appendChild(document.createTextNode(`地點 ${getgatheringDetails.data[0].place}`))


        // let time = document.createElement('li');
        // time.className = "list-group-item";
        // time.appendChild(document.createTextNode(`時間 ${getgatheringDetails.data[0].start_at}`))



        // let minParticipant = document.createElement('li');
        // minParticipant.className = "list-group-item";
        // minParticipant.appendChild(document.createTextNode(`幾人成團 ${getgatheringDetails.data[0].min_participant}`))



        // let maxParticipant = document.createElement('li');
        // maxParticipant.className = "list-group-item";
        // maxParticipant.appendChild(document.createTextNode(`人數上限 ${getgatheringDetails.data[0].max_participant}`))


        // let currentParticipant = document.createElement('li');
        // currentParticipant.className = "list-group-item";
        // currentParticipant.appendChild(document.createTextNode(`目前人數 ${parseInt(gathering.numOfParticipants) + 1
        //     } `))



        // let statusCode = document.createElement('li');
        // statusCode.className = "list-group-item";
        // statusCode.appendChild(document.createTextNode(`狀態 ${getgatheringDetails.data[0].status} `))



        // let host = document.createElement('li');
        // host.className = "list-group-item";
        // host.appendChild(document.createTextNode(`主揪 ${hostInfo.hostName}`))


        // let joinEventButton = document.createElement('a');
        // joinEventButton.className = "btn btn-primary";
        // joinEventButton.id = "joinEvent";
        // joinEventButton.style = "display: none;"
        // joinEventButton.setAttribute("data-bs-toggle", "button")
        // joinEventButton.setAttribute("autocomplete", "off")
        // joinEventButton.appendChild(document.createTextNode("我要加入"))


        // let quitEventButton = document.createElement('a');
        // quitEventButton.className = "btn btn-primary";
        // quitEventButton.id = "quitEvent";
        // quitEventButton.style = "display: none;"
        // quitEventButton.setAttribute("data-bs-toggle", "button")
        // quitEventButton.setAttribute("autocomplete", "off")
        // quitEventButton.appendChild(document.createTextNode("我要退出"))


        // let fullEventButton = document.createElement('a');
        // fullEventButton.className = "btn ";
        // fullEventButton.id = "fullEvent";
        // fullEventButton.style = "display: none; background-color: 'rebeccapurple';"
        // fullEventButton.setAttribute("data-bs-toggle", "button")
        // fullEventButton.setAttribute("autocomplete", "off")
        // fullEventButton.appendChild(document.createTextNode("名額已滿"))


        // console.log('check', parseInt(gathering.numOfParticipants) + 1, getgatheringDetails.data[0].max_participant)
        // if ((parseInt(gathering.numOfParticipants) + 1) >= getgatheringDetails.data[0].max_participant) {
        //     joinEventButton.style = "display: none;"
        //     fullEventButton.style = "display: block;"
        // } else {
        //     joinEventButton.style = "display: block;"
        //     fullEventButton.style = "display: none;"
        // }

        // // let returnHome = document.createElement('a');
        // // returnHome.className = "btn btn-primary btn-sm box4";


        // // returnHome.setAttribute("onclick", 'location.href=" /index.html"')
        // // returnHome.setAttribute("data-bs-toggle", "button")
        // // returnHome.setAttribute("autocomplete", "off")
        // // returnHome.appendChild(document.createTextNode("回首頁"))




        // listGroup.appendChild(listGroupItem)
        // listGroup.appendChild(time)
        // listGroup.appendChild(minParticipant)
        // listGroup.appendChild(maxParticipant)
        // listGroup.appendChild(currentParticipant)

        // listGroup.appendChild(statusCode)
        // listGroup.appendChild(host)
        // listGroup.appendChild(joinEventButton)
        // listGroup.appendChild(quitEventButton)
        // listGroup.appendChild(fullEventButton)

        // listGroup.appendChild(document.createElement('br'))
        // // listGroup.appendChild(returnHome)



        // gatheringDetail.insertBefore(listGroup, gatheringDetail.firstChild)
        // // gatheringDetail.appendChild(listGroup)

        // gatheringDetail.insertBefore(cardBody, gatheringDetail.firstChild)

        // gatheringDetail.insertBefore(eventMap, gatheringDetail.firstChild)

        // gatheringDetail.insertBefore(eventPic, gatheringDetail.firstChild)




        // let returnHome = document.createElement('a');
        // returnHome.className = "btn btn-primary btn-sm box4";


        // returnHome.setAttribute("onclick", 'location.href=" /index.html"')
        // returnHome.setAttribute("data-bs-toggle", "button")
        // returnHome.setAttribute("autocomplete", "off")
        // returnHome.appendChild(document.createTextNode("回首頁"))

        // gatheringDetail.appendChild(document.createElement('br'))

        // gatheringDetail.appendChild(returnHome)


        // statusCode






        initProfile()


























    </script>







    <script>







        document.getElementById("navbarDropdownMenuLink").addEventListener('click', () => {
            if (!localStorage.getItem('token')) {
                document.getElementsByClassName('dropdown-sign')[0].style = "display: block;"
                let sign = document.getElementsByClassName('dropdown-signed')
                for (i = 0; i < sign.length; i++) {
                    sign[i].style.display = "none";
                }

            } else {
                document.getElementsByClassName('dropdown-sign')[0].style = "display: none;"
                let signed = document.getElementsByClassName('dropdown-signed')
                for (i = 0; i < signed.length; i++) {
                    signed[i].style.display = "block";
                }

            }

        })


        document.getElementById("signout").addEventListener('click', () => {
            localStorage.removeItem("token")


            Swal.fire({
                title: 'Success!',
                text: '已將您登出',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(function () {
                window.location.href = '/sign.html'
            })

        })




    </script>







    <script>







    </script>
















</body>



</html>