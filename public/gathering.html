<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Project</title>

    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script> -->


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- <link rel="stylesheet" type="text/css" href="styles/map.css"> -->

    <script src="/socket.io/socket.io.js"></script>

    <script>
        // var socket = io();
    </script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- <link rel="stylesheet" href="sweetalert2.min.css"> -->
    <!-- <script src="src/init_map.js"></script> -->

    <!-- <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
        integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
        crossorigin="anonymous"></script> -->


    <!-- <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 50%;
            width: 50vw;
        }
    </style> -->

    <link rel="stylesheet" type="text/css" href="styles/header_footer.css">
    <link rel="stylesheet" type="text/css" href="./styles/gathering.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style type="text/css">
        body {
            font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }


        #left-info {
            /* height: 100%; */
            overflow: auto;
        }

        #left-info::-webkit-scrollbar {
            width: 1px;
            /* background-color: black; */
        }



        #right {
            margin: 0;
            padding-bottom: 0.5rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100%;
            max-height: 90%;
            display: flex;

        }

        /* #groupChatRoom {

            border: 2px #55adff solid;
        } */



        /* #map {
            height: 65%;
            width: 50vw;
        } */








        #groupChatRoom {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 90%;
            max-height: 100%;
            /* border: thin;
            border-color: turquoise; */

            box-shadow: 1px 1px 8px grey;
            /* width:460px;
            line-height:100px; */
            /* text-align: center; */


        }



        #messagesForm {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            /* position: fixed; */
            bottom: 0;
            /* left: 0;
            right: 0; */
            display: flex;
            /* height: 3rem; */
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            /* width: 20%; */

        }

        #messageInput {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        #input:focus {
            outline: none;
        }

        #form>button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
            height: inherit;
            overflow: scroll;
        }

        #messages>li {
            padding: 0.5rem 1rem;
        }

        #messages>li:nth-child(odd) {
            background: #efefef;
        }



        :root {
            --animate-duration: 500ms;
            --animate-delay: 1s;
            --animate-repeat: 1;
        }
    </style>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>





    <div class='wrap'>

        <div id="header">


            <div class="main-header">
                <a class="logo name" href="/index.html">
                    <!-- <img src="https://www.pngkit.com/png/full/207-2070900_the-gathering-logo-clear-gathering-word.png"
                        height="48"> -->

                    <img src="./assets/logo3.png" height="48">


                </a>
                <!-- <div class="main-nav">
                    <a href="/index.html?tag=women" class="tag">女裝</a>
                    <div class="tag-line">|</div>
                    <a href="/index.html?tag=men" class="tag">男裝</a>
                    <div class="tag-line">|</div>
                    <a href="/index.html?tag=accessories" class="tag">配件</a>

                </div> -->

                <!-- <input class="search" /> -->

                <!-- <a class="cart">
                    <img src="/img/icons/cart.png" height="44" />
                    <div class="count">0</div>
                </a> -->

                <!-- Button trigger modal -->





                <div class="host">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#staticBackdrop" id="hostbutton">
                        我要開團
                    </button>

                </div>

                <div class="signinout">

                    <a href="/sign.html"><img src="./assets/1031506_authorize_enter_login_sign in_signin_icon.png"
                            height="30"></a>

                </div>


                <div class="member">
                    <a href="/profile.html"><img src="https://dft5bbbk1fziz.cloudfront.net/img/icons/member.png"
                            height="44"></a>
                </div>


            </div>




        </div>


        <div id="left-block">


            <div class="rating-box">
                <h1 class="rating-boxH1">Rating-System</h1>
                <div class="rating">
                    <span class="fa fa-star-o"></span>
                    <span class="fa fa-star-o"></span>
                    <span class="fa fa-star-o"></span>
                    <span class="fa fa-star-o"></span>
                    <span class="fa fa-star-o"></span>
                </div>
                <h4 id="rating-value">
                    </h1>
            </div>
            <script src="./src/rating.js"></script>

        </div>



        <!-- <div id="left-pic"></div> -->

        <!-- <div id="left-map"></div> -->



        <!-- Async script executes immediately and must be after any DOM elements used in callback. -->


        <!-- <script>localStorage.setItem("token", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcm92aWRlciI6Im5hdGl2ZSIsIm5hbWUiOiJ0ZXN0IiwiZW1haWwiOiJ0ZXN0QHRlc3QuY29tIiwicGljdHVyZSI6bnVsbCwiZXhwaXJlc0luIjoiMjU5MjAwMCIsImlhdCI6MTYzNTU4MTQ1NH0.Laoi5iUfR4NePhMBuZdzOoZkpijMALNj28yXE2aQWgw")</script> -->
        <div id=left-info>

            <div id="gatheringDetail">

            </div>

            <!-- <div id=joinEvent style="width: fit-content;">
            
                <button type="button" class="btn btn-primary" data-bs-toggle="button" autocomplete="off">我要加入</button>
            </div>

            <div id=quitEvent style="width: fit-content; display: none;">
            
                <button type="button" class="btn btn-primary" data-bs-toggle="button" autocomplete="off">我要退出</button>
            </div> -->





            <br>
            <!-- <div onclick='location.href="/index.html"' class="box4">
             
                <button type="button" class="btn btn-primary btn-sm" disabled data-bs-toggle="button"
                    autocomplete="off">回首頁</button>
            </div> -->

            <br>


















        </div>



        <div id=right style="display:none;">
            <!-- <div id=participant-list>
                <h3 style=" text-align: center;">成員</h3>
                <ul id="participants"></ul>


            </div> -->
            <div id=groupChatRoom style="height: 95vh;">

                <h6 style=" text-align: center;">成員</h6>
                <ul id="participants"></ul>

                <h6 style=" text-align: center;">群組聊天室</h6>
                <!-- <div id="container">
                        <div id="status-box">Server: <span id="status">-</span> / <span id="online">0</span> online.
                        </div>
                        <div id="content">
                            <div class="msg">
                                <span class="name">Duye</span>
                                Hello!
                            </div>
                            <div class="msg">
                                <span class="name">Alice</span>
                                Hi!
                            </div>
                        </div>
                        <div id="send-box">
                            <form id="send-form">
                                <input type="text" name="name" id="name" placeholder="暱稱">
                                <input type="text" name="msg" id="msg" placeholder="說點什麼？">
                                <input type="submit" value="送出">
                            </form>
                        </div>
                    </div> -->


                <ul id="messages"></ul>
                <div>
                    <form id="messagesForm" action="">
                        <input id="messageInput" autocomplete="off" /> <button>Send</button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>




        // const accessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcm92aWRlciI6Im5hdGl2ZSIsIm5hbWUiOiJ0ZXN0IiwiZW1haWwiOiJ0ZXN0QHRlc3QuY29tIiwicGljdHVyZSI6bnVsbCwiZXhwaXJlc0luIjoiMjU5MjAwMCIsImlhdCI6MTYzNTU4MTQ1NH0.Laoi5iUfR4NePhMBuZdzOoZkpijMALNj28yXE2aQWgw"

        // localStorage.setItem("token", accessToken)




        // async function fetchData(url, accessToken) {
        //     try {
        //         let response
        //         if (accessToken) {

        //             const headers = {
        //                 'Content-Type': 'application/json',
        //                 'Authorization': `Bearer ${accessToken}`
        //             }
        //             response = await fetch(url, { headers: headers });
        //         } else {
        //             response = await fetch(url);
        //         }


        //         const output = response.json();
        //         console.log(output);

        //         return output
        //     } catch (e) {
        //         console.log("error", e);
        //     }
        // }












        function fetchData(src, accessToken) {
            // console.log('access', accessToken)

            function processStatus(response) {
                // 狀態 "0" 是處理本地檔案 (例如Cordova/Phonegap等等)
                if (response.status === 200 || response.status === 0) {
                    return Promise.resolve(response)
                } else {
                    return Promise.reject(new Error(response.statusText))
                }
            }

            if (accessToken) {
                const headers = {
                    // 'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }

                return fetch(src, { headers: headers })
                    .then(processStatus)
                    .then((response) => { return response.json(); })
                    .catch((error) => {
                        console.log(error);
                    })

            } else {
                const headers = {}
                return fetch(src)
                    .then(processStatus)
                    .then((response) => { return response.json(); })
                    .catch((error) => {
                        console.log(error);
                    })
            }






        }






        // async function ajax(src, accessToken) {

        //     const xhr = new XMLHttpRequest()

        //     xhr.onload = function () {
        //         if (xhr.readyState === 4 && xhr.status === 200) {
        //             let response = JSON.parse(xhr.responseText)
        //             // response = xhr.responseText;
        //             console.log('ajax response', response)
        //             return response
        //         }
        //     }

        //     await xhr.open('GET', src)
        //     if (accessToken) {
        //         // console.log('accessToken: ', accessToken)
        //         xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
        //     }
        //     console.log('ready to send ajax')
        //     let output = await xhr.send()

        //     return output





        // }

        async function initMap() {


            var socket = io();

            var hostInfo = {};
            var user = {}
            var gathering = {}

            const accessToken = localStorage.getItem("token")



            let url = location.href

            if (url.indexOf('?') !== -1 & url.split('?')[1].split('=')[0] == 'id') {
                const gatheringId = url.split('?')[1].split('=')[1]
                console.log('gatheringId', gatheringId)


                // let accessToken = localStorage.getItem("token")

                let participantsData = await fetchData(`/api/1.0/getgatherings/participants?id=${gatheringId}`, accessToken)

                console.log('participantsData', participantsData, gatheringId)
                gathering.numOfParticipants = participantsData.data.length

                console.log('gathering', gathering)




                let getgatheringDetails = await fetchData(`/api/1.0/getgatherings/details?id=${gatheringId}`, accessToken)

                // console.log('getgatheringDetails.data[0].lat', getgatheringDetails.data[0].lat)
                gathering.title = getgatheringDetails.data[0].title


                console.log('getgatheringDetails.user', getgatheringDetails.user)

                // console.log('getgatheringDetails.data[0]', getgatheringDetails.data[0])

                // initMap(response.data[0].lat, response.data[0].lng)


                hostInfo.hostName = getgatheringDetails.data[0].name
                hostInfo.hostId = getgatheringDetails.data[0].host_id
                // console.log('response.data.host_id', response.data[0].host_id)



                // let mapDiv = document.getElementById("left-map")
                // mapDiv.style = 'height: 100%;width: 98%;'

                const gatheringDetail = document.getElementById('gatheringDetail')

                gatheringDetail.class = "card"
                gatheringDetail.style = "width: 28rem; height:80%;"


                let eventPic = document.createElement('img')
                eventPic.src = getgatheringDetails.data[0].picture

                eventPic.className = "card-img-top"
                eventPic.alt = "..."


                eventPic.style = "height:28vh;object-fit: contain;background-image:url('https://mir-s3-cdn-cf.behance.net/project_modules/disp/a5f35a112938979.601ee0c09cecd.gif')"


                gatheringDetail.appendChild(eventPic)


                let eventMap = document.createElement('div')
                eventMap.id = "left-map";



                gatheringDetail.appendChild(eventMap)


                let cardBody = document.createElement('div')
                cardBody.className = "card-body";

                let cardTitle = document.createElement('h5')
                cardTitle.className = "card-title";
                cardTitle.appendChild(document.createTextNode(` ${getgatheringDetails.data[0].title}`))



                let cardDescriptiion = document.createElement('p')
                cardDescriptiion.className = "card-text";
                cardDescriptiion.style = "white-space: pre-line;"
                cardDescriptiion.appendChild(document.createTextNode(` ${getgatheringDetails.data[0].description}`))
                // console.log(getgatheringDetails.data[0].description)

                cardBody.appendChild(cardTitle)
                cardBody.appendChild(cardDescriptiion)




                gatheringDetail.appendChild(cardBody)






                let listGroup = document.createElement('ul');
                listGroup.className = "list-group list-group-flush";




                let listGroupItem = document.createElement('li');
                listGroupItem.className = "list-group-item";
                listGroupItem.appendChild(document.createTextNode(`地點 ${getgatheringDetails.data[0].place}`))


                let time = document.createElement('li');
                time.className = "list-group-item";
                time.appendChild(document.createTextNode(`時間 ${getgatheringDetails.data[0].start_at}`))



                let minParticipant = document.createElement('li');
                minParticipant.className = "list-group-item";
                minParticipant.appendChild(document.createTextNode(`幾人成團 ${getgatheringDetails.data[0].min_participant}`))



                let maxParticipant = document.createElement('li');
                maxParticipant.className = "list-group-item";
                maxParticipant.appendChild(document.createTextNode(`人數上限 ${getgatheringDetails.data[0].max_participant}`))


                let currentParticipant = document.createElement('li');
                currentParticipant.className = "list-group-item";
                currentParticipant.appendChild(document.createTextNode(`目前人數 ${parseInt(gathering.numOfParticipants) + 1}`))



                let statusCode = document.createElement('li');
                statusCode.className = "list-group-item";
                statusCode.appendChild(document.createTextNode(`狀態 ${getgatheringDetails.data[0].status}`))



                let host = document.createElement('li');
                host.className = "list-group-item";
                host.appendChild(document.createTextNode(`主揪 ${hostInfo.hostName}`))


                let joinEventButton = document.createElement('a');
                joinEventButton.className = "btn btn-primary";
                joinEventButton.id = "joinEvent";
                joinEventButton.setAttribute("data-bs-toggle", "button")
                joinEventButton.setAttribute("autocomplete", "off")
                joinEventButton.appendChild(document.createTextNode("我要加入"))


                let quitEventButton = document.createElement('a');
                quitEventButton.className = "btn btn-primary";
                quitEventButton.id = "quitEvent";
                quitEventButton.style = "display: none;"
                quitEventButton.setAttribute("data-bs-toggle", "button")
                quitEventButton.setAttribute("autocomplete", "off")
                quitEventButton.appendChild(document.createTextNode("我要退出"))




                let returnHome = document.createElement('a');
                returnHome.className = "btn btn-primary btn-sm box4";


                returnHome.setAttribute("onclick", 'location.href=" /index.html"')
                returnHome.setAttribute("data-bs-toggle", "button")
                returnHome.setAttribute("autocomplete", "off")
                returnHome.appendChild(document.createTextNode("回首頁"))




                listGroup.appendChild(listGroupItem)
                listGroup.appendChild(time)
                listGroup.appendChild(minParticipant)
                listGroup.appendChild(maxParticipant)
                listGroup.appendChild(currentParticipant)

                listGroup.appendChild(statusCode)
                listGroup.appendChild(host)
                listGroup.appendChild(joinEventButton)
                listGroup.appendChild(quitEventButton)
                listGroup.appendChild(document.createElement('br'))
                listGroup.appendChild(returnHome)

                gatheringDetail.appendChild(listGroup)



                statusCode





                const initPoint = { lat: getgatheringDetails.data[0].lat, lng: getgatheringDetails.data[0].lng };
                console.log('initPoint', initPoint)
                map = new google.maps.Map(document.getElementById("left-map"), {
                    center: initPoint,
                    zoom: 18,
                });

                // let mapDiv = document.getElementById("left-map")
                // mapDiv.style = 'height: 100%;width: 98%;'


                let marker = new google.maps.Marker()

                marker = new google.maps.Marker({
                    position: initPoint, //marker的放置位置

                    map: map
                });








                let participant;
                url = location.href
                // const gatheringId = url.split('?')[1].split('=')[1]



                const messages = document.getElementById('messages');
                const form = document.getElementById('messagesForm');
                const input = document.getElementById('messageInput');
                const right = document.getElementById('right');
                const joinEvent = document.getElementById('joinEvent');
                const quitEvent = document.getElementById('quitEvent');





                // ----------------------------------------------------------------------------------------








                if (accessToken) {


                    let profile = await fetchData('/api/1.0/user/getmemberprofile', accessToken)

                    console.log('response getmemberprofile', profile)


                    user = profile.data
                    console.log('user', user)
                    // messages.style = "display:block;"
                    // form.style = "display:block;"
                    // right.style = "display:block;"




                    let participantsData = await fetchData(`/api/1.0/getgatherings/participants?id=${gatheringId}`, accessToken)


                    console.log('participantsData', participantsData)

                    const hostNameForChatRoom = document.createElement('li');

                    hostNameForChatRoom.textContent = `主揪 ${hostInfo.hostName} `

                    participants.appendChild(hostNameForChatRoom);

                    joinEvent.style = "display:block;"
                    quitEvent.style = "display:none;"

                    for (let i in participantsData.data) {

                        console.log('participantsData.data[i]', participantsData.data[i].id, user.id)

                        if (user.id == participantsData.data[i].id) {
                            console.log('in participant list')
                            right.style = "display:block;"
                            joinEvent.style = "display:none;"
                            quitEvent.style = "display:block;"

                        }

                        participant = document.createElement('li');
                        participant.textContent = participantsData.data[i].user_name;
                        participant.setAttribute('onclick', `location.href = '/profile.html?id=${participantsData.data[i].id}'; `)
                        participant.style = `cursor: pointer; `

                        participants.appendChild(participant);



                    }







                    // ------------------------------------------------------------------------------------




                    let chatRecord
                    socket.on('addRoom', message => {
                        console.log(message)

                        // socket.on('initialRoom', chatList => {
                        //     console.log('initialRoom', 'chatList.length', chatList.length)

                        //     for (let i in chatList) {
                        //         chatRecord = document.createElement('li');
                        //         // item.textContent = userName + ':' + msg;
                        //         chatRecord.textContent = chatList[i].content;
                        //         messages.appendChild(chatRecord);
                        //     }


                        //     document.getElementById('messages').scrollBy(0, document.getElementById('messages').scrollHeight)




                        // })

                    })





                    // let room = 'room1'
                    let room = location.href.split('?')[1].split('=')[1]

                    // console.log('{ room: room, userId: user.id }', room, user.id)
                    socket.emit('addRoom', { room: room, userId: user.id })

                    socket.on(`${room}+${user.id}`, chatRecord => {
                        // console.log('chatRecord', chatRecord)



                        // item.textContent = userName + ':' + msg;
                        // let messages = document.getElementById('messages')

                        for (let i in chatRecord) {
                            // console.log('current user.id', user.id)
                            // console.log('chatRecord[i].user_id', chatRecord[i].user_id)
                            const item = document.createElement('li');

                            // console.log('comapre', 'chatRecord[i].user_id: ', chatRecord[i].user_id, 'user.id:', user.id)

                            if (chatRecord[i].user_id == user.id) {
                                item.style = 'text-align: right;'
                                item.textContent = `我: ${chatRecord[i].content} `
                            } else {
                                item.textContent = `${chatRecord[i].user_name}: ${chatRecord[i].content} `;
                            }

                            messages.appendChild(item);

                        }


                        document.getElementById('messages').scrollBy(0, document.getElementById('messages').scrollHeight)





                    })









                    const messages = document.getElementById('messages');
                    const form = document.getElementById('messagesForm');
                    const input = document.getElementById('messageInput');

                    let messagesList = []
                    let chat
                    form.addEventListener('submit', function (e) {
                        console.log('submit')
                        e.preventDefault();
                        if (input.value) {
                            console.log('input.value', input.value)
                            console.log('user.id', user.id)
                            chat = { speaker: user.name, content: input.value, roomId: room, userId: user.id }
                            // chat.speaker = user.name
                            // chat.content = input.value
                            socket.emit('chat message', chat);

                            messagesList.push(chat)
                            input.value = '';
                            console.log(messagesList)
                        }
                    })


                    let item;
                    socket.on('chat message', function (msg) {
                        item = document.createElement('li');
                        // item.textContent = userName + ':' + msg;

                        // console.log('comapre', 'msg.speaker: ', msg.speaker, 'user.name:', user.name)

                        if (msg.speaker == user.name) {
                            item.style = 'text-align: right;'
                            item.textContent = `我: ${msg.content} `;
                        } else {
                            item.textContent = `${msg.speaker}: ${msg.content} `;

                            Swal.fire({
                                title: `${msg.speaker} say: ${msg.content} `,
                                position: 'bottom-end',
                                showClass: {

                                    popup: 'animate__animated animate__fadeIn'
                                },

                                timer: 1500,
                                hideClass: {
                                    popup: 'animate__animated animate__fadeOutUp'
                                },
                                backdrop: false,
                                width: '18rem',
                            })

                        }

                        messages.appendChild(item);

                        document.getElementById('messages').scrollBy(0, document.getElementById('messages').scrollHeight)


                        // Swal.fire({
                        //     position: 'top-end',
                        //     icon: 'success',
                        //     title: msg.content,
                        //     showConfirmButton: false,
                        //     timer: 500
                        // })

                        // Swal.fire({
                        //     title: `${msg.speaker} say: ${msg.content} `,
                        //     position: 'bottom-end',
                        //     showClass: {

                        //         popup: 'animate__animated animate__fadeIn'
                        //     },

                        //     timer: 1500,
                        //     hideClass: {
                        //         popup: 'animate__animated animate__fadeOutUp'
                        //     },
                        //     backdrop: false,
                        //     width: '18rem',
                        // })

                    })























































                } else {

                    // messages.style = "display:none;"
                    // form.style = "display:none;"
                    right.style = "display:none;"

                }














                document.getElementById("joinEvent").addEventListener('click', async () => {

                    // const gatheringId = url.split('?')[1].split('=')[1]

                    // const accessToken = localStorage.getItem("token")

                    if (accessToken) {

                        let joinGathering = await fetchData(`/api/1.0/gatherings/attendGathering/join?id=${gatheringId}`, accessToken)



                        console.log('joinGathering', joinGathering)


                        let participantData = { gatheringId: gatheringId, gatheringTitle: gathering.title, hostId: hostInfo.hostId, hostName: hostInfo.hostName, participantName: joinGathering.data.participant.participant_name }


                        console.log('participantData', participantData)

                        alert('成功加入')
                        socket.emit('addParticipant', participantData)


                        // socket.emit(`host_newparticipant_${ participantData.hostId } `, msg.content)




                        window.location.reload();




                    } else {

                        Swal.fire({
                            title: 'Error!',
                            text: '請先登入',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        }).then(function () {
                            window.location.href = '/sign.html'
                        })

                    }

                })



                document.getElementById("quitEvent").addEventListener('click', async () => {

                    // const gatheringId = url.split('?')[1].split('=')[1]

                    // const accessToken = localStorage.getItem("token")

                    if (accessToken) {

                        let quitGathering = await fetchData(`/api/1.0/gatherings/attendGathering/quit?id=${gatheringId}`, accessToken)



                        console.log('quitGathering', quitGathering)


                        let participantData = { gatheringId: gatheringId, gatheringTitle: gathering.title, hostId: hostInfo.hostId, hostName: hostInfo.hostName, participantName: quitGathering.data.participant.participant_name }


                        console.log('participantData', participantData)

                        alert('成功退出')
                        socket.emit('removeParticipant', participantData)


                        // socket.emit(`host_newparticipant_${ participantData.hostId } `, msg.content)




                        window.location.reload();




                    } else {

                        Swal.fire({
                            title: 'Error!',
                            text: '請先登入',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        }).then(function () {
                            window.location.href = '/sign.html'
                        })

                    }

                })




















            } else {
                console.log('wrong parameter')
            }










































        }



        // id: req.user.id,
        //     provider: req.user.provider,
        //         name: req.user.name,
        //             email: req.user.email,
        //                 picture: req.user.picture,
        //                     introduction: req.user.introduction,
        //                         job: req.user.job,
        //                             title: req.user.title,
        //                                 age: req.user.age,
        //                                     popularity: req.user.popularity,
        //                                         coin: req.user.coin,










































        // var socket = io();
        // const form = document.getElementById('messagesForm');




        //  const accessToken = localStorage.getItem("token");
        // fetch("/api/1.0/getgatherings/hostGathering", {

        //     body: dataToSent,
        //     headers: new Headers({
        //         "Content-Type": "multipart/form-data",
        //         "Authorization": `Bearer ${ accessToken } `
        //     }),
        //     method: "POST"
        // }).then((e => e.json())).then((e => {
        //     console.log(e)
        //     alert('error')
        // }
        // )).then(window.alert("註冊成功！")).catch((e => {
        //     console.log(e)
        // }
        // ))

        // socket.on('create-room', () => {
        //     const roomId = uuid(`${ Date.now() } `, uuid.DNS);
        //     socket.join(roomId);
        //     socket.emit('join-room-message', `You've join ${roomId} room`);
        //     io.to(roomId).emit('room-brocast', `${socket.id} has join this room`);
        // })

        // socket.on('join-room', (roomId) => {
        //     socket.join(roomId);
        //     socket.emit('join-room-message', `You've join ${roomId} room`);
        //     io.sockets.to(roomId).emit('room-brocast', `${socket.id} has join this room`);
        // });


























    </script>


    <script>
        // 當觸發連線建立事件
        // 發送 greet 事件給伺服器
        // socket.on("connect", function () {
        //     socket.emit("greet");
        // });

        // 當收到伺服器回傳到 greet 事件
        // 將內容轉到 div 中呈現
        // socket.on("greet", function (msg) {
        //     document.getElementById("groupChatRoom").innerText = msg;
        // });
    </script>


    <script>


        // document.addEventListener("DOMContentLoaded", () => {

        //     var status = document.getElementById("status");
        //     var online = document.getElementById("online");

        //     socket.on("connect", function () {
        //         status.innerText = "Connected.";
        //     });

        //     socket.on("disconnect", function () {
        //         status.innerText = "Disconnected.";
        //     });

        //     socket.on("online", function (amount) {
        //         online.innerText = amount;
        //     });
        // });


    </script>

    <script>



        // var socket = io();
        // const form = document.getElementById('messagesForm');
        // const input = document.getElementById('messageInput');



        // //  const accessToken = localStorage.getItem("token");
        // // fetch("/api/1.0/getgatherings/hostGathering", {

        // //     body: dataToSent,
        // //     headers: new Headers({
        // //         "Content-Type": "multipart/form-data",
        // //         "Authorization": `Bearer ${accessToken}`
        // //     }),
        // //     method: "POST"
        // // }).then((e => e.json())).then((e => {
        // //     console.log(e)
        // //     alert('error')
        // // }
        // // )).then(window.alert("註冊成功！")).catch((e => {
        // //     console.log(e)
        // // }
        // // ))

        // // socket.on('create-room', () => {
        // //     const roomId = uuid(`${Date.now()}`, uuid.DNS);
        // //     socket.join(roomId);
        // //     socket.emit('join-room-message', `You've join ${roomId} room`);
        // //     io.to(roomId).emit('room-brocast', `${socket.id} has join this room`);
        // // })

        // // socket.on('join-room', (roomId) => {
        // //     socket.join(roomId);
        // //     socket.emit('join-room-message', `You've join ${roomId} room`);
        // //     io.sockets.to(roomId).emit('room-brocast', `${socket.id} has join this room`);
        // // });


        // socket.on('addRoom', message => {
        //     console.log(message)
        // })





        // // let room = 'room1'
        // let room = location.href.split('?')[1].split('=')[1]
        // socket.emit('addRoom', room)

        // let messagesList = []

        // form.addEventListener('submit', function (e) {
        //     console.log('submit')
        //     e.preventDefault();
        //     if (input.value) {
        //         console.log('input.value', input.value)
        //         socket.emit('chat message', input.value);
        //         messagesList.push(input.value)
        //         input.value = '';
        //     }
        // })



        // socket.on('chat message', function (msg) {
        //     const item = document.createElement('li');
        //     // item.textContent = userName + ':' + msg;
        //     item.textContent = msg;
        //     messages.appendChild(item);
        //     document.getElementById('messages').scrollBy(0, document.getElementById('messages').scrollHeight)

        // })

    </script>


    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXg0bmVrXJ6hF8Nq5voQG6TbA5UQFha7k&callback=initMap&v=weekly"
        async></script>



</body>

</html>